{% sw_extends '@Storefront/storefront/base.html.twig' %}

{# Adding Nosto tagging #}
{% block base_body_script %}

    {{ parent() }}

    {# Nosto tagging #}
    {% block od_nosto_integration_tagging %}

        {% set type = od_nosto_page_type(activeRoute, page.cmsPage.type) %}

        {% block od_nosto_integration_tagging_global %}
            {% sw_include '@OdNostoIntegration/storefront/component/nosto-integration/page-tagging.html.twig' with {
                type: type
            } %}
        {% endblock %}

        {% block od_nosto_integration_tagging_advanced %}
            {% sw_include '@OdNostoIntegration/storefront/component/nosto-integration/'~type~'-tagging.html.twig' ignore missing %}
        {% endblock %}

    {% endblock %}

    {# Nosto connect script #}
    {% block od_nosto_integration_connect_script %}
        {% set accountID = config('NostoIntegration.settings.accounts.accountID') %}
        {% set initializeAfter = config('NostoIntegration.settings.afterIteration') %}
        {% if initializeAfter %}
            {% if accountID %}
                {% apply spaceless %}
                    <script type="text/javascript">

                        (function () {
                            let localStorage = window.localStorage;
                            var executed = false;
                            window.onscroll = function () {
                                if (!executed) {
                                    if (localStorage && (!localStorage.nostoFirstInteraction || localStorage.nostoFirstInteraction !== 'done')) {
                                        localStorage.setItem('nostoFirstInteraction', 'done');
                                        var name = "nostojs";
                                        window[name] = window[name] || function (cb) {
                                            (window[name].q = window[name].q || []).push(cb);
                                        };

                                    } else if (localStorage && localStorage.nostoFirstInteraction === 'done') {
                                        var name = "nostojs";
                                        window[name] = window[name] || function (cb) {
                                            (window[name].q = window[name].q || []).push(cb);
                                        };
                                    }
                                    executed = true;
                                }
                            }
                        })();
                    </script>
                    <script src="//connect.nosto.com/include/{{ accountID }}" async></script>
                {% endapply %}
            {% endif %}
        {% else %}
            {% if accountID %}
                {% apply spaceless %}
                    <script type="text/javascript">
                        (function () {
                            var name = "nostojs";
                            window[name] = window[name] || function (cb) {
                                (window[name].q = window[name].q || []).push(cb);
                            };
                        })();
                    </script>
                    <script src="//connect.nosto.com/include/{{ accountID }}" async></script>
                {% endapply %}
            {% endif %}
        {% endif %}
    {% endblock %}

{% endblock %}
