{% sw_extends '@Storefront/storefront/base.html.twig' %}

{# Adding Nosto tagging #}
{% block base_body_script %}

    {{ parent() }}

    {# Nosto tagging #}
    {% block od_nosto_integration_tagging %}

        {% set type = od_nosto_page_type(activeRoute, page.cmsPage.type) %}

        {% block od_nosto_integration_tagging_global %}
            {% sw_include '@OdNostoIntegration/storefront/component/nosto-integration/page-tagging.html.twig' with {
                type: type
            } %}
        {% endblock %}

        {% block od_nosto_integration_tagging_advanced %}
            {% sw_include '@OdNostoIntegration/storefront/component/nosto-integration/'~type~'-tagging.html.twig' ignore missing %}
        {% endblock %}

    {% endblock %}

    {# Nosto connect script #}
    {% block od_nosto_integration_connect_script %}
        {% set accountID = config('NostoIntegration.settings.accounts.accountID') %}
        {% set initializeAfter = config('NostoIntegration.settings.afterIteration') %}
        {% if accountID %}
            {% apply spaceless %}
                <script type="text/javascript">
                    var localStorage = window.localStorage;

                    function initNosto() {
                        var name = "nostojs";
                        window[name] = window[name] || function (cb) {
                            (window[name].q = window[name].q || []).push(cb);
                        };
                    }

                    function prepareForInteraction() {
                        if (localStorage && (!localStorage.nostoFirstInteraction || localStorage.nostoFirstInteraction !== 'done')) {
                            localStorage.setItem('nostoFirstInteraction', 'done');
                        }
                        initNosto()
                    }
                </script>
            {% endapply %}
            {% if initializeAfter %}
                {% apply spaceless %}
                    <script type="text/javascript">
                        (function () {
                            if (localStorage && (localStorage.nostoFirstInteraction && localStorage.nostoFirstInteraction === 'done')) {
                                initNosto();
                            } else {
                                window.addEventListener('scroll', prepareForInteraction, {once: true});
                            }
                        })();
                    </script>
                    <script src="//connect.nosto.com/include/{{ accountID }}" async></script>
                {% endapply %}
            {% else %}
                {% apply spaceless %}
                    <script type="text/javascript">
                        initNosto();
                    </script>
                {% endapply %}
            {% endif %}
        {% endif %}
    {% endblock %}
{% endblock %}
